<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÍGNEO - FICHA DE PERSONAJE</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
        }

        @font-face {
            font-family: 'Determination';
            src: url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        }

        body {
            background: #000000;
            font-family: 'Press Start 2P', monospace;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .estrellas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .estrella {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #ffffff;
            opacity: 0;
            animation: parpadear 3s infinite;
        }

        @keyframes parpadear {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .caja-undertale {
            position: relative;
            z-index: 10;
            max-width: 900px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            border: 3px solid #ffffff;
            background: #000000;
            padding: 30px;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
            color: #ffffff;
        }

        .linea {
            width: 100%;
            height: 3px;
            background: #ffffff;
            margin: 20px 0 30px;
        }

        /* INFO SUPERIOR */
        .info-superior {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            border: 2px solid #ffffff;
            padding: 20px;
        }

        .imagen-personaje {
            width: 150px;
            height: 150px;
            border: 2px solid #ffffff;
            background: #0a0a0a;
            overflow: hidden;
        }

        .imagen-personaje img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .datos-basicos {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .dato-item {
            border: 1px solid #444444;
            padding: 10px;
        }

        .dato-label {
            font-size: 0.5rem;
            color: #7f7f7f;
        }

        .dato-valor {
            font-size: 0.7rem;
            color: #ffffff;
        }

        /* BARRAS */
        .seccion-barras {
            margin-bottom: 30px;
            border: 2px solid #ffffff;
            padding: 20px;
        }

        .barras-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .barra-item {
            margin-bottom: 15px;
        }

        .barra-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #ffff66;
            margin-bottom: 5px;
        }

        .barra-contenedor {
            width: 100%;
            height: 20px;
            border: 2px solid #ffffff;
            background: #000000;
        }

        .barra-llenado {
            height: 100%;
            transition: width 0.3s;
        }

        .barra-fuerza { background: #ff5555; }
        .barra-magia { background: #5555ff; }
        .barra-esencia { background: #ff55ff; }
        .barra-vida { background: #55ff55; }

        /* ATRIBUTOS */
        .seccion-atributos {
            margin-bottom: 30px;
            border: 2px solid #ffffff;
            padding: 20px;
        }

        .seccion-titulo {
            font-size: 1rem;
            margin-bottom: 15px;
            border-bottom: 1px solid #ffffff;
            padding-bottom: 8px;
        }

        .atributos-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .atributo-item {
            border: 1px solid #444444;
            padding: 10px;
        }

        .atributo-nombre {
            font-size: 0.5rem;
            color: #7f7f7f;
            margin-bottom: 5px;
        }

        .atributo-puntos {
            display: flex;
            gap: 3px;
            margin: 5px 0;
        }

        .punto {
            width: 12px;
            height: 12px;
            border: 1px solid #ffffff;
            background: #000000;
        }

        .punto.activo { background: #ffff66; }
        .punto.inactivo { opacity: 0.3; }

        /* INVENTARIO */
        .seccion-inventario {
            margin-bottom: 20px;
            border: 2px solid #ffffff;
            padding: 20px;
        }

        .inventario-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .inventario-header h2 {
            font-size: 0.9rem;
            color: #ffffff;
        }

        .inventario-header span {
            color: #ffff66;
            font-size: 0.7rem;
        }

        .inventario-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .objeto-btn {
            width: 100%;
            border: 2px solid #ffffff;
            background: #0a0a0a;
            padding: 15px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            color: white;
            text-align: center;
        }

        .objeto-btn:hover {
            border-color: #ffff66;
            transform: translate(-2px, -2px);
        }

        .objeto-btn.equipado {
            border-color: #ffff66;
            box-shadow: 0 0 10px #ffff66;
        }

        .vacio-btn {
            width: 100%;
            border: 2px dashed #444444;
            padding: 15px;
            background: #000000;
            color: #444444;
            font-size: 0.5rem;
            text-align: center;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #000000;
            border: 3px solid #ffffff;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-botones {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            background: #000000;
            border: 2px solid #ffffff;
            color: white;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.6rem;
            padding: 12px;
            cursor: pointer;
        }

        .modal-btn:hover {
            border-color: #ffff66;
            color: #ffff66;
        }

        .btn-volver {
            background: #000000;
            border: 2px solid #ffffff;
            color: white;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.9rem;
            padding: 15px 30px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .btn-volver:hover {
            border-color: #ffff66;
            color: #ffff66;
        }
    </style>
</head>
<body>
    <div class="estrellas" id="estrellas"></div>

    <div class="caja-undertale">
        <h1>FICHA DE PERSONAJE</h1>
        <div class="linea"></div>

        <!-- INFO SUPERIOR -->
        <div class="info-superior">
            <div class="imagen-personaje" id="imagen-personaje"></div>
            <div class="datos-basicos" id="datos-basicos"></div>
        </div>

        <!-- BARRAS -->
        <div class="seccion-barras">
            <div class="barras-grid" id="barras-container"></div>
        </div>

        <!-- HABILIDADES -->
        <div class="seccion-atributos">
            <div class="seccion-titulo">HABILIDADES</div>
            <div class="atributos-grid" id="habilidades-container"></div>
        </div>

        <!-- CUERPO -->
        <div class="seccion-atributos">
            <div class="seccion-titulo">CUERPO</div>
            <div class="atributos-grid" id="cuerpo-container"></div>
        </div>

        <!-- MENTE -->
        <div class="seccion-atributos">
            <div class="seccion-titulo">MENTE</div>
            <div class="atributos-grid" id="mente-container"></div>
        </div>

        <!-- SOCIAL -->
        <div class="seccion-atributos">
            <div class="seccion-titulo">SOCIAL</div>
            <div class="atributos-grid" id="social-container"></div>
        </div>

        <!-- INVENTARIO -->
        <div class="seccion-inventario">
            <div class="inventario-header">
                <h2>INVENTARIO</h2>
                <span id="equipados-count">0/3</span>
            </div>
            
            <div id="inventario-container"></div>
        </div>

        <!-- BOTÓN VOLVER -->
        <button class="btn-volver" onclick="window.location.href='menu-desbloqueado.html'">
            VOLVER AL MENÚ
        </button>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modal" style="display: none;">
        <div class="modal-content">
            <p id="modal-texto"></p>
            <div class="modal-botones" id="modal-botones"></div>
        </div>
    </div>

    <script>
        // ===== CONEXIÓN A SUPABASE =====
        const SUPABASE_URL = 'https://iwqeikrjhyqxyduvhhkg.supabase.co';
        const SUPABASE_KEY = 'unsrhffwguwfebhppptz';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // GENERAR ESTRELLAS
        for (let i = 0; i < 150; i++) {
            const estrella = document.createElement('div');
            estrella.className = 'estrella';
            estrella.style.left = Math.random() * 100 + '%';
            estrella.style.top = Math.random() * 100 + '%';
            estrella.style.animationDelay = Math.random() * 3 + 's';
            document.getElementById('estrellas').appendChild(estrella);
        }

        // ===== VARIABLES GLOBALES =====
        let personaje = null;
        let inventarioItems = [];

        // ===== CARGAR PERSONAJE DESDE SUPABASE =====
        async function cargarPersonaje() {
            // Obtener personaje activo de localStorage
            const personajeActivo = localStorage.getItem('personajeActivo');
            
            if (!personajeActivo) {
                window.location.href = 'login.html';
                return;
            }

            const { nombre } = JSON.parse(personajeActivo);

            try {
                // Cargar datos del personaje
                const { data: personajeData, error: personajeError } = await supabase
                    .from('personajes')
                    .select('*')
                    .eq('nombre', nombre)
                    .single();

                if (personajeError || !personajeData) {
                    console.error('Error cargando personaje:', personajeError);
                    window.location.href = 'login.html';
                    return;
                }

                personaje = personajeData;

                // Cargar inventario del personaje
                const { data: inventarioData, error: inventarioError } = await supabase
                    .from('inventario')
                    .select('*')
                    .eq('personaje_id', personaje.id);

                if (!inventarioError && inventarioData) {
                    inventarioItems = inventarioData;
                }

                // Renderizar todo
                renderizarPersonaje();

            } catch (error) {
                console.error('Error:', error);
                window.location.href = 'login.html';
            }
        }

        // ===== RENDERIZAR PERSONAJE =====
        function renderizarPersonaje() {
            // Mostrar imagen si existe
            if (personaje.imagen_url) {
                document.getElementById('imagen-personaje').innerHTML = `<img src="${personaje.imagen_url}">`;
            }

            // Mostrar datos básicos
            document.getElementById('datos-basicos').innerHTML = `
                <div class="dato-item"><div class="dato-label">NOMBRE</div><div class="dato-valor">${personaje.nombre || '---'}</div></div>
                <div class="dato-item"><div class="dato-label">RAZA</div><div class="dato-valor">${personaje.raza || '---'}</div></div>
                <div class="dato-item"><div class="dato-label">RANGO</div><div class="dato-valor">${personaje.rango || '---'}</div></div>
                <div class="dato-item"><div class="dato-label">EDAD</div><div class="dato-valor">${personaje.edad || '---'}</div></div>
                <div class="dato-item"><div class="dato-label">GÉNERO</div><div class="dato-valor">${personaje.genero || '---'}</div></div>
                <div class="dato-item"><div class="dato-label">ALTURA</div><div class="dato-valor">${personaje.altura || '---'}</div></div>
            `;

            // Mostrar barras (si tienes estos campos en Supabase)
            // Si no los tienes, puedes calcularlos con las habilidades
            const fuerza = personaje.fuerza || 100;
            const magia = personaje.magia || 100;
            const esencia = personaje.esencia || 100;
            const vida = personaje.vida || 100;
            const vidaMax = personaje.vida || 100;

            document.getElementById('barras-container').innerHTML = `
                <div class="barra-item">
                    <div class="barra-header"><span>FUERZA</span><span>${fuerza}</span></div>
                    <div class="barra-contenedor"><div class="barra-llenado barra-fuerza" style="width: ${fuerza/2}%"></div></div>
                </div>
                <div class="barra-item">
                    <div class="barra-header"><span>MAGIA</span><span>${magia}</span></div>
                    <div class="barra-contenedor"><div class="barra-llenado barra-magia" style="width: ${magia/2}%"></div></div>
                </div>
                <div class="barra-item">
                    <div class="barra-header"><span>ESENCIA</span><span>${esencia}</span></div>
                    <div class="barra-contenedor"><div class="barra-llenado barra-esencia" style="width: ${esencia/2}%"></div></div>
                </div>
                <div class="barra-item">
                    <div class="barra-header"><span>VIDA</span><span>${vida}/${vidaMax}</span></div>
                    <div class="barra-contenedor"><div class="barra-llenado barra-vida" style="width: ${(vida/vidaMax)*100}%"></div></div>
                </div>
            `;

            // Mostrar habilidades (vienen como JSON en Supabase)
            if (personaje.habilidades) {
                mostrarAtributos('habilidades-container', personaje.habilidades);
            }

            if (personaje.cuerpo) {
                mostrarAtributos('cuerpo-container', personaje.cuerpo);
            }

            if (personaje.mente) {
                mostrarAtributos('mente-container', personaje.mente);
            }

            if (personaje.social) {
                mostrarAtributos('social-container', personaje.social);
            }

            // Renderizar inventario
            renderizarInventario();
        }

        function mostrarAtributos(containerId, datos) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let html = '';
            
            Object.entries(datos).forEach(([nombre, valor]) => {
                let puntos = '';
                for (let i = 0; i < 5; i++) {
                    puntos += `<div class="punto ${i < valor ? 'activo' : 'inactivo'}"></div>`;
                }
                
                html += `
                    <div class="atributo-item">
                        <div class="atributo-nombre">${nombre}</div>
                        <div class="atributo-puntos">${puntos}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ===== INVENTARIO =====
        function renderizarInventario() {
            const container = document.getElementById('inventario-container');
            const equipados = inventarioItems.filter(o => o.equipado).length;
            document.getElementById('equipados-count').textContent = `${equipados}/3`;

            let html = '<div class="inventario-grid">';
            
            inventarioItems.forEach(item => {
                const claseExtra = item.equipado ? 'equipado' : '';
                html += `<button class="objeto-btn ${claseExtra}" onclick="abrirModal(${item.id})">`;
                html += `<div style="font-size:0.5rem; margin-bottom:5px;">${item.nombre || 'Objeto'}</div>`;
                html += `<div style="font-size:0.4rem; color:#ffff66;">x${item.cantidad || 1}</div>`;
                html += `</button>`;
            });

            for (let i = inventarioItems.length; i < 3; i++) {
                html += `<div class="vacio-btn">VACÍO</div>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ===== MODAL =====
        window.abrirModal = function(id) {
            const item = inventarioItems.find(i => i.id === id);
            if (!item) return;

            document.getElementById('modal-texto').textContent = item.nombre || 'Objeto';
            
            let botones = '';
            if (item.tipo === 'consumible') {
                botones = `<button class="modal-btn" onclick="usarItem(${id})">USAR</button>`;
            } else {
                if (item.equipado) {
                    botones = `<button class="modal-btn" onclick="quitarItem(${id})">QUITAR</button>`;
                } else {
                    botones = `<button class="modal-btn" onclick="equiparItem(${id})">EQUIPAR</button>`;
                }
            }
            
            botones += `<button class="modal-btn" onclick="cerrarModal()">CANCELAR</button>`;
            document.getElementById('modal-botones').innerHTML = botones;
            
            document.getElementById('modal').style.display = 'flex';
        };

        window.cerrarModal = function() {
            document.getElementById('modal').style.display = 'none';
        };

        window.equiparItem = async function(id) {
            const item = inventarioItems.find(i => i.id === id);
            const equipados = inventarioItems.filter(o => o.equipado).length;
            
            if (equipados >= 3) {
                alert('* Solo puedes equipar 3 objetos');
                cerrarModal();
                return;
            }
            
            // Actualizar en Supabase
            const { error } = await supabase
                .from('inventario')
                .update({ equipado: true })
                .eq('id', id);
            
            if (!error) {
                item.equipado = true;
                renderizarInventario();
            }
            
            cerrarModal();
        };

        window.quitarItem = async function(id) {
            const item = inventarioItems.find(i => i.id === id);
            
            // Actualizar en Supabase
            const { error } = await supabase
                .from('inventario')
                .update({ equipado: false })
                .eq('id', id);
            
            if (!error) {
                item.equipado = false;
                renderizarInventario();
            }
            
            cerrarModal();
        };

        window.usarItem = async function(id) {
            const item = inventarioItems.find(i => i.id === id);
            
            if (item.cantidad <= 1) {
                // Eliminar si es el último
                const { error } = await supabase
                    .from('inventario')
                    .delete()
                    .eq('id', id);
                
                if (!error) {
                    inventarioItems = inventarioItems.filter(i => i.id !== id);
                }
            } else {
                // Reducir cantidad
                const { error } = await supabase
                    .from('inventario')
                    .update({ cantidad: item.cantidad - 1 })
                    .eq('id', id);
                
                if (!error) {
                    item.cantidad--;
                }
            }
            
            renderizarInventario();
            cerrarModal();
        };

        // INICIALIZAR
        cargarPersonaje();
    </script>
</body>
</html>
